# DartSystem 开发文档

## 系统设计思路

### 1. 模块化设计
- **解耦合原则**：各个功能模块（相机、检测、通信、录制）独立设计，通过清晰的接口交互
- **可替换性**：每个模块都可以独立升级或替换，如更换不同品牌的相机或使用不同的通信协议
- **配置驱动**：关键参数都可配置化，便于调试和适应不同环境

### 2. 实时性优化
- **多线程架构**：
  - 图像采集线程：负责从工业相机获取图像
  - 检测处理线程：进行绿光检测和位置计算
  - 通信发送线程：处理串口数据传输
  - 视频录制线程：异步处理屏幕录制
- **数据流设计**：
  - 使用队列管理数据流转，避免阻塞
  - 实现生产者-消费者模式，确保数据同步
  - 采用无锁设计减少线程竞争

### 3. 鲁棒性设计
- **异常处理机制**：
  - 相机断连自动重连：监控相机状态，异常时自动恢复
  - 串口通信异常恢复：实现重连和数据重传机制
  - 检测失败优雅降级：保持最后有效值，避免突变
- **状态管理**：
  - 系统状态机：清晰定义各模块状态转换
  - 日志系统：记录关键操作和异常信息
  - 错误追踪：完整的错误堆栈和上下文信息

## 遇到的问题与解决方案

### 1. 图像采集问题

**问题描述**：
- 工业相机初始化经常失败
- 图像帧率不稳定，有时会跳帧
- 在不同光照条件下图像质量差异大

**解决方案**：
1. 相机初始化：
   - 实现多次重试机制
   - 添加详细的错误日志
   - 优化SDK参数配置

2. 帧率稳定：
   - 使用帧率控制算法
   - 实现帧缓冲队列
   - 优化图像传输效率

3. 图像质量：
   - 自动曝光时间调节
   - 动态增益控制
   - 图像预处理增强

### 2. 目标检测问题

**问题描述**：
- 绿光检测在复杂背景下不稳定
- 存在较多误检情况
- 目标快速移动时容易丢失

**解决方案**：
1. 检测稳定性：
   - 使用HSV颜色空间提高抗干扰能力
   - 添加形态学处理去除噪点
   - 实现区域权重矩阵优化检测

2. 减少误检：
   - 面积过滤
   - 形状分析
   - 时序连续性验证

3. 目标跟踪：
   - 实现卡尔曼滤波器
   - 添加运动预测
   - 多帧历史记录平滑

### 3. 通信问题

**问题描述**：
- 串口数据传输不稳定
- 通信延迟影响实时性
- 数据同步和丢失问题

**解决方案**：
1. 通信协议优化：
   - 设计可靠的帧格式
   - 添加校验机制
   - 实现应答确认

2. 延迟优化：
   - 优化数据包大小
   - 调整发送频率
   - 实现数据压缩

3. 数据同步：
   - 时间戳机制
   - 序列号管理
   - 丢包重传策略

### 4. 视频录制问题

**问题描述**：
- Wayland环境下录制黑屏
- 录制文件可能损坏
- 占用系统资源过高

**解决方案**：
1. 环境适配：
   - 切换到X11环境
   - 使用合适的捕获方法
   - 优化ffmpeg参数

2. 文件管理：
   - 实现文件完整性检查
   - 添加自动备份机制
   - 优化存储策略

3. 资源优化：
   - 异步录制
   - 压缩参数调优
   - 缓存管理

## 优化方向

### 1. 性能优化
- **算法优化**：
  - GPU加速图像处理
  - 检测算法并行化
  - 内存访问优化

- **资源管理**：
  - 实现内存池
  - 优化线程调度
  - 改进缓存策略

### 2. 功能增强
- **智能化**：
  - 深度学习目标检测
  - 参数自适应调整
  - 智能异常诊断

- **可视化**：
  - 3D轨迹显示
  - 实时数据图表
  - 系统状态监控

### 3. 工程化改进
- **部署优化**：
  - Docker容器化
  - 自动化部署脚本
  - 远程管理接口

- **测试完善**：
  - 自动化测试框架
  - 性能基准测试
  - 压力测试方案

## 开发建议

### 1. 环境配置
- 使用X11环境开发
- 正确安装相机SDK
- 配置合适的权限

### 2. 调试方法
- 使用HSV调节器
- 录制回放分析
- 串口监控工具

### 3. 性能分析
- 使用性能分析器
- 日志分析系统
- 压力测试验证 