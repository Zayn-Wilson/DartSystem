# 绿光检测代码改进记录

## 2024-03-21 优化检测稳定性

### 主要改动内容

1. 图像预处理优化
   ```python
   # 使用更小的高斯模糊核，保留更多细节
   hsv = cv2.GaussianBlur(hsv, (3, 3), 0)  # 原来是 (5,5)

   # 优化形态学操作
   kernel_open = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
   kernel_close = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (7, 7))
   ```

2. 面积阈值调整
   ```python
   MIN_AREA = 50    # 原来是 100
   MAX_AREA = 15000 # 原来是 10000
   ```

3. 滤波器优化
   ```python
   # 卡尔曼滤波器参数优化
   processNoiseCov = np.array([[1e-3, 0.], [0., 1e-3]], np.float32)  # 原来是 1e-4
   measurementNoiseCov = np.array([[1e-2]], np.float32)              # 原来是 1e-1
   ```

4. 时序处理改进
   ```python
   history_size = 3        # 原来是 5
   MAX_LOST_FRAMES = 5     # 原来是 10
   smoothed_offset = int(np.median(self.offset_history))  # 原来是 mean
   ```

5. 简化权重计算
   ```python
   # 直接使用面积作为权重，不再考虑位置权重
   weight = area  # 原来是基于位置的权重矩阵
   ```

### 改进目的

1. **提高检测灵敏度**
   - 降低最小面积阈值，使系统能够检测到更小的目标
   - 优化图像预处理参数，保留更多细节信息

2. **加快响应速度**
   - 减小历史记录长度，使系统更快响应目标变化
   - 降低丢失帧数容忍度，更快重新获取目标

3. **提高跟踪稳定性**
   - 优化卡尔曼滤波器参数，提高预测准确性
   - 使用中值滤波代替平均值，减少异常值影响

4. **改善空心目标检测**
   - 调整形态学操作参数，更好地处理空心或不规则目标
   - 优化核大小，平衡噪声去除和细节保留

5. **简化判断逻辑**
   - 移除复杂的位置权重计算
   - 直接使用面积作为权重，提高代码可维护性

### 效果

- 成功解决了空心目标检测不稳定的问题
- 提高了系统整体的检测稳定性
- 加快了系统响应速度
- 简化了代码结构，更易于维护和调试

### 后续可能的优化方向

1. 根据实际使用情况进一步调整参数
2. 考虑添加目标预测功能
3. 优化异常情况处理
4. 添加更多调试信息输出 